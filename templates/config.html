<!-- C:\Users\Anonymous\Desktop\tele\templates\config.html -->
{% extends 'layout.html' %}

{% block content %}
<h2>系统配置</h2>
<p class="text-muted">在此处配置Telegram API信息和钉钉机器人Webhook。</p>

<div class="card mt-4">
    <div class="card-body">
        <form method="POST">
            <div class="mb-3">
                <label for="api_id" class="form-label">Telegram API ID</label>
                <input type="text" class="form-control" id="api_id" name="api_id" value="{{ config.api_id or '' }}" required>
                <div class="form-text">你的应用 API ID。</div>
            </div>
            <div class="mb-3">
                <label for="api_hash" class="form-label">Telegram API Hash</label>
                <input type="text" class="form-control" id="api_hash" name="api_hash" value="{{ config.api_hash or '' }}" required>
                <div class="form-text">你的应用 API Hash。</div>
            </div>
            <div class="mb-3">
                <label for="phone_number" class="form-label">手机号码</label>
                <input type="text" class="form-control" id="phone_number" name="phone_number" value="{{ config.phone_number or '' }}" placeholder="+国家代码手机号" required>
                <div class="form-text">用于登录Telegram的手机号，格式如：+8612345678901。</div>
            </div>
            <hr>
            <div class="mb-3">
                <label for="dingtalk_webhook" class="form-label">钉钉 Webhook URL</label>
                <input type="text" class="form-control" id="dingtalk_webhook" name="dingtalk_webhook" value="{{ config.dingtalk_webhook or '' }}">
                <div class="form-text">用于发送关键词匹配通知的钉钉机器人Webhook地址（可选）。</div>
            </div>
            <div class="mb-3">
                <label for="dingtalk_secret" class="form-label">钉钉签名密钥 (Secret)</label>
                <input type="text" class="form-control" id="dingtalk_secret" name="dingtalk_secret" value="{{ config.dingtalk_secret or '' }}">
                <div class="form-text">如果你的钉钉机器人开启了“加签”安全设置，请在此输入密钥（可选）。</div>
            </div>
            <button type="submit" class="btn btn-primary">保存配置</button>
        </form>
        <hr>
        <!-- 钉钉测试按钮 -->
        <form action="{{ url_for('test_dingtalk') }}" method="POST" class="d-inline">
             <button type="submit" class="btn btn-outline-info">发送钉钉测试消息</button>
        </form>
    </div>
</div>

<!-- 新的、美化的监控状态卡片 -->
<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title">监控状态</h5>
        <div id="status-container" class="d-flex align-items-center p-3 rounded">
            <!-- JS动态填充 -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const statusContainer = document.getElementById('status-container');

    function updateStatus() {
        fetch('/status')
            .then(response => response.json())
            .then(data => {
                let content = '';
                if (data.is_running) {
                    statusContainer.className = 'd-flex align-items-center p-3 rounded bg-success-subtle text-success-emphasis';
                    content = `
                        <div class="spinner-grow spinner-grow-sm me-3" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                        <div>
                            <strong>运行中</strong>
                            <div class="small">监控服务已在后台成功启动。要停止，请关闭命令行窗口。</div>
                        </div>
                    `;
                } else {
                    statusContainer.className = 'd-flex align-items-center p-3 rounded bg-danger-subtle text-danger-emphasis';
                    content = `
                        <div class="me-3" style="width: 1rem; height: 1rem; background-color: currentColor; border-radius: 50%;"></div>
                        <div>
                            <strong>已停止</strong>
                            <div class="small">监控服务当前未运行。请重启程序以启动监控。</div>
                        </div>
                    `;
                }
                statusContainer.innerHTML = content;
            })
            .catch(error => {
                statusContainer.className = 'd-flex align-items-center p-3 rounded bg-warning-subtle text-warning-emphasis';
                statusContainer.innerHTML = '<div><strong>状态未知</strong><div class="small">无法获取后台服务状态。</div></div>';
                console.error('Error fetching status:', error);
            });
    }

    // 页面加载时立即更新一次，并在之后每5秒轮询一次
    updateStatus();
    setInterval(updateStatus, 5000);
});
</script>

{% endblock %}
